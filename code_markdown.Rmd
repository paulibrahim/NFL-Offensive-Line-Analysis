---
title: "Code"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

Load necessary libraries:
```{r libraries}
library(tidyr)
library(data.table)
library(R.utils)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(ggrepel)
library(pracma)
library(ggvoronoi)
library(sf)
library(DT)
library(shiny)
library(ggpubr)
library(gridExtra)
library(sfsmisc)
library(useful)
library(MASS)
library(geometry)
library(survival)
```

Download data from: https://github.com/903124/NFL-live-tracking-data/tree/main/output_file
```{r game_converter}
setwd("C:/")
file_vec <- c("broncos-at-jets-2020-reg-4.csv.gz", "chargers-at-saints-2020-reg-5.csv.gz",
               "chiefs-at-ravens-2020-reg-3.csv.gz", "eagles-at-49ers-2020-reg-4.csv.gz",
               "falcons-at-packers-2020-reg-4.csv.gz","vikings-at-seahawks-2020-reg-5.csv.gz") #vector of file names, function input
gameId_vec <- c("2020_04_DEN_NYJ", "2020_05_LAC_NO", "2020_03_KC_BAL", "2020_04_PHI_SF", "2020_04_ATL_GB", "2020_05_MIN_SEA") #vector of gameId's corresponding to files, function input

game_conv_fun <- function(file_vec, gameId_vec){
game_dt_list <- list()
i <- 1
for (file_name in file_vec) {
dt <-  fread(file_name)
dt <- as.data.frame(sapply(dt, function(x) gsub("'", "", x)))
dt <- as.data.frame(sapply(dt, function(x) gsub("\\[", "", x)))
dt <- as.data.frame(sapply(dt, function(x) gsub("\\]", "", x)))

dt$V1 <- as.numeric(as.character(dt$V1))
dt$play_id <- as.numeric(as.character(dt$play_id))

dt_home <- (separate_rows(dt, data.home_player_x_coord,data.home_player_y_coord, data.home_player_id,
                          sep=",", convert = TRUE))
dt_home[ ,c('data.home_player_firstname', 'data.home_player_lastname', 'data.home_player_position',
       'data.home_jersey_number','data.home_jeresy_number','data.home_jerset_number',
       'data.home_jerest_number','data.away_player_x_coord','data.away_player_y_coord',
       'data.away_player_id','data.away_player_firstname','data.away_player_lastname',
       'data.away_player_position','data.away_jersey_number','data.away_jeresy_number',
       'data.away_jerset_number','data.away_jerest_number','data.ball_x','data.ball_y')] <- list(NULL)

dt_home$data.home_player_x_coord <- as.numeric(as.character(dt_home$data.home_player_x_coord))
dt_home$data.home_player_y_coord <- as.numeric(as.character(dt_home$data.home_player_y_coord))
dt_home$data.home_player_id <- as.numeric(as.character(dt_home$data.home_player_id))
dt_home <- dt_home[dt_home$data.home_player_x_coord>30 & dt_home$data.home_player_x_coord<750 & dt_home$data.home_player_y_coord>35 & dt_home$data.home_player_y_coord<350,]

dt_away <- (separate_rows(dt, data.away_player_x_coord,data.away_player_y_coord, data.away_player_id,
                          sep=",", convert = TRUE))
dt_away[ ,c('data.away_player_firstname', 'data.away_player_lastname', 'data.away_player_position',
            'data.away_jersey_number','data.away_jeresy_number','data.away_jerset_number',
            'data.away_jerest_number','data.home_player_x_coord','data.home_player_y_coord',
            'data.home_player_id','data.home_player_firstname','data.home_player_lastname',
            'data.home_player_position','data.home_jersey_number','data.home_jeresy_number',
            'data.home_jerset_number','data.home_jerest_number','data.ball_x','data.ball_y')] <- list(NULL)

dt_away$data.away_player_x_coord <- as.numeric(as.character(dt_away$data.away_player_x_coord))
dt_away$data.away_player_y_coord <- as.numeric(as.character(dt_away$data.away_player_y_coord))
dt_away$data.away_player_id <- as.integer(as.character(dt_away$data.away_player_id))
dt_away <- dt_away[dt_away$data.away_player_x_coord>30 & dt_away$data.away_player_x_coord<750 & dt_away$data.away_player_y_coord>35 & dt_away$data.away_player_y_coord<350,]

dt_ball <- (separate_rows(dt, data.ball_x,data.ball_y,
                          sep=",", convert = TRUE))
dt_ball[ ,c('data.home_player_x_coord', 'data.home_player_y_coord', 'data.home_player_id',
            'data.home_player_firstname','data.home_player_lastname','data.home_player_position',
            'data.home_jersey_number','data.home_jeresy_number','data.home_jerset_number',
            'data.home_jerest_number','data.away_player_x_coord','data.away_player_y_coord',
            'data.away_player_id','data.away_player_firstname','data.away_player_lastname',
            'data.away_player_position','data.away_jersey_number','data.away_jeresy_number',
            'data.away_jerset_number', 'data.away_jerest_number')] <- list(NULL)

dt_ball$data.ball_x <- as.numeric(as.character(dt_ball$data.ball_x))
dt_ball$data.ball_y <- as.numeric(as.character(dt_ball$data.ball_y))
dt_ball <- dt_ball[dt_ball$data.ball_x>30 & dt_ball$data.ball_x<750 & dt_ball$data.ball_y>35 & dt_ball$data.ball_y<350,]
dt_ball$gen_indexer <- 1:nrow(dt_ball)

home_v1_agg <- aggregate(data.home_player_id~V1, dt_home, length)
away_v1_agg <- aggregate(data.away_player_id~V1, dt_away, length)
ball_v1_agg <- aggregate(gen_indexer~V1, dt_ball, length)

home_v1_agg <- home_v1_agg[home_v1_agg$data.home_player_id==11,]
away_v1_agg <- away_v1_agg[away_v1_agg$data.away_player_id==11,]
ball_v1_agg <- ball_v1_agg[ball_v1_agg$gen_indexer==1,]

all_v1_agg <- merge(home_v1_agg, away_v1_agg, by="V1")
all_v1_agg <- merge(all_v1_agg, ball_v1_agg, by="V1")

dt_home <- dt_home[dt_home$V1 %in% all_v1_agg$V1,] 
dt_away <- dt_away[dt_away$V1 %in% all_v1_agg$V1,] 
dt_ball <- dt_ball[dt_ball$V1 %in% all_v1_agg$V1,] 

dt_home <- dt_home[order(dt_home$play_id, dt_home$V1),]
dt_away <- dt_away[order(dt_away$play_id, dt_away$V1),]
dt_ball <- dt_ball[order(dt_ball$play_id, dt_ball$V1),]

dt_home$V2 <- sort(rep(1:(nrow(dt_home)/11), 11))
dt_away$V2 <- sort(rep(1:(nrow(dt_away)/11), 11))
dt_ball$V2 <- sort(rep(1:(nrow(dt_ball)), 1))

home_play_agg <- aggregate(V2~play_id, dt_home, length)
home_play_agg$tot_frames <- (home_play_agg$V2)/11
all_frames_vec <- as.vector(ceiling(1:sum(home_play_agg$tot_frames)/11))
home_play_agg$V2 <- NULL
home_play_agg$tot_frames_cumsum <- c(0,cumsum(home_play_agg$tot_frames)[-length(home_play_agg$tot_frames)])
all_frames_df <- data.frame(play_id=(home_play_agg[rep(row.names(home_play_agg), 11*home_play_agg$tot_frames), 1]), V2=dt_home$V2)
home_play_agg$tot_frames <- NULL
all_frames_df <- merge(all_frames_df, home_play_agg, by="play_id")
all_frames_df$frameId <- all_frames_df$V2-all_frames_df$tot_frames_cumsum
all_frames_df <- all_frames_df[seq(1, nrow(all_frames_df), 11), ]
all_frames_df$tot_frames_cumsum <- NULL
all_frames_df$play_id <- NULL

dt_home <- merge(dt_home, all_frames_df, by=("V2"))
dt_away <- merge(dt_away, all_frames_df, by=("V2"))
dt_ball <- merge(dt_ball, all_frames_df, by=("V2"))

names(dt_home)[names(dt_home) == "data.home_player_x_coord"] <- "x_coords"
names(dt_home)[names(dt_home) == "data.home_player_y_coord"] <- "y_coords"
names(dt_home)[names(dt_home) == "data.home_player_id"] <- "nflId"
dt_home$team <- "home"

names(dt_away)[names(dt_away) == "data.away_player_x_coord"] <- "x_coords"
names(dt_away)[names(dt_away) == "data.away_player_y_coord"] <- "y_coords"
names(dt_away)[names(dt_away) == "data.away_player_id"] <- "nflId"
dt_away$team <- "away"

names(dt_ball)[names(dt_ball) == "data.ball_x"] <- "x_coords"
names(dt_ball)[names(dt_ball) == "data.ball_y"] <- "y_coords"
dt_ball$nflId <- -1
dt_ball$team <- "ball"
dt_ball$gen_indexer <- NULL

dt_all <- bind_rows(dt_home, dt_away, dt_ball)
names(dt_all)[names(dt_all) == "data.event"] <- "event"
names(dt_all)[names(dt_all) == "play_id"] <- "playId"
dt_all$V1 <- NULL
dt_all$V2 <- NULL
dt_all$x_coords <- (dt_all$x_coords-30)/6
dt_all$y_coords <- (dt_all$y_coords-30)/6

dt_all$gameId <- gameId_vec[i]

game_dt_list[[i]] <- dt_all

i <- i+1
}
dt_binded_exp <- rbindlist(game_dt_list)

dt_binded_exp[ ,c('data.pass_chance','data.exact_los','data.exact_first_down')] <- list(NULL)
# dt_binded_exp$data.pass_chance <- NULL
# dt_binded_exp$data.exact_los <- NULL
# # dt_binded_exp$data.exact_los <- NULL
# dt_binded_exp$data.exact_first_down <- NULL
return(dt_binded_exp)
}
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
